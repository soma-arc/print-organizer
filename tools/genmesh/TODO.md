# genmesh v1 実装 TODO

## 参照ドキュメント

- 仕様: docs/spec/genmesh_v1.md
- スキーマ: docs/schemas/{manifest,bricks-index,report}.v1.schema.json

---

## Phase 0: ビルド基盤 ✅

### T0.1 CMake + vcpkg セットアップ ✅
- vcpkg.json で openvdb, nlohmann-json を宣言
- CMakePresets.json を追加 (configure + build preset)
- `cmake --build --preset default` でビルドが通る
- Accept: 空の main.cpp で実行ファイルが生成される

### T0.2 エラーコード・終了コード基盤 ✅
- `error_code.h`: GENMESH_E/W コード定数 (§9.3, §9.4)
- `exit_code.h`: 終了コード enum (0,1,2,3,4,5) (§9.1)
- Accept: ヘッダが include でき、ビルドが通る

### T0.3 構造化ログ (stderr) ✅
- §9.2 の形式に従う stderr ログユーティリティ
  - `LEVEL CODE: message | key=value ...`
- `--log-level` でフィルタ可能
- Accept: `LOG_ERROR(code, msg, {k,v})` マクロ/関数が動く単体テスト

---

## Phase 1: CLI引数パース + manifest検証 ✅

### T1.1 CLI引数パース ✅
- `--manifest`, `--in`, `--out` (必須)
- `--write-stl`, `--write-vdb`, `--iso`, `--adaptivity`
- `--force`, `--log-level`
- `--debug-generate sphere|box`
- Accept: 不正引数 → exit 1, 必須引数欠落 → exit 2, ヘルプ表示

### T1.2 manifest パース + 検証 ✅
- manifest.v1.schema.json の必須フィールドを読み取り (§4.2)
- 整合性ルール全項目を検証 (§4.3)
  - dims * voxel_size == aabb_size (eps 1e-6)
  - coordinate_system 固定値チェック
  - adaptivity 範囲, brick.size enum, background_value_mm 制約
- 不一致は exit 2 + 構造化エラー
- Accept: valid/invalid fixture で検証パス / エラーコード一致

### T1.3 出力ディレクトリ処理 ✅
- `--out` mkdir -p (§3.2)
- 既存ファイル検出 → exit 3 / `--force` で許可 (§3.3)
- Accept: 存在しないdir作成, 既存ファイルでエラー, --force で続行

---

## Phase 2: ブリック入力読み取り ✅

### T2.1 bricks.index.json パース + 検証 ✅
- bricks-index.v1.schema.json の全フィールドを読み取り (§5.4)
- manifest との整合性検証 (§5.6):
  - version, brick_size, dtype, axis_order, dims 一致
  - 重複 (bx,by,bz) がない
- Accept: valid/invalid fixture で検証パス

### T2.2 bricks.bin 読み取り ✅
- offset_bytes + payload_bytes が範囲内か検証
- payload_bytes == B^3 * sizeof(dtype) (raw)
- CRC32 検証 (任意フィールドがある場合)
- メモリ上に brick データ配列を構築
- Accept: fixture の brick データを正しく読み取れる

---

## Phase 3: debug-generate (Rust不要E2E)

### T3.1 sphere / box 距離場生成
- `--debug-generate sphere`: 半径 R の球SDF
- `--debug-generate box`: 直方体SDF
- manifest を内部生成 (固定パラメータ)
- Accept: manifest + dense配列が Phase 4 に渡せる

---

## Phase 4: VDB構築

### T4.1 OpenVDB初期化 + Grid生成
- `openvdb::initialize()` (§6)
- `Transform::createLinearTransform(voxel_size)` + aabb_min translation
- FloatGrid, background = background_value_mm
- Accept: 空の Grid が作成でき、Transform が正しい

### T4.2 ブリックデータ → VDB挿入
- brick 配列を走査し、Grid にボクセル値を設定
- スパース規約: index にないブリック → background_value_mm (§5.5)
- f16 → float 変換
- Accept: debug-generate sphere の Grid が active voxel count > 0

---

## Phase 5: メッシュ化 + 出力

### T5.1 volumeToMesh
- `volumeToMesh(grid, points, tris, quads, iso, adaptivity)` (§7)
- quad → 2 tri 分割: (0,1,2) + (0,2,3) (§7.1)
- Accept: sphere で tri count > 0

### T5.2 STL バイナリ書き出し
- 80B ヘッダ: "Generated by genmesh" + 0埋め (§7.1)
- 法線: normalize(cross(v1-v0, v2-v0)), 不定 → (0,0,0)
- テンポラリ → rename のアトミック書き込み
- Accept: 出力STLが外部ビューア (e.g. MeshLab) で開ける

### T5.3 VDB書き出し (--write-vdb)
- `openvdb::io::File` で volume.vdb を出力
- Accept: `vdb_print volume.vdb` が正常に読める

---

## Phase 6: report.json

### T6.1 report.json 生成
- report.v1.schema.json に準拠 (§8.2)
- timing_ms: 各フェーズの計測
- stats: aabb, counts, degenerate_count
- warnings / errors: 構造化
- Accept: 出力JSONがスキーマバリデーションを通る

### T6.2 失敗時report
- どのフェーズで止まったか stage + progress (§8.3)
- --out が書ける限り report を出す
- Accept: 不正入力 → exit 2 かつ report.json が残る

---

## Phase 7: テスト整備

### T7.1 fixtures 作成
- 最小 manifest + 1-brick の valid fixture
- invalid fixture (欠落フィールド, 不整合値, etc.)
- Accept: ctest で全テスト green

### T7.2 E2E テスト (debug-generate)
- `genmesh --debug-generate sphere --out tmp/`
  → mesh.stl + report.json が生成される
- report.json の stats で tri > 0, degenerate >= 0
- Accept: ctest で green, CI再現可能

### T7.3 退行検知 baseline
- sphere fixture の統計を記録 (tri count, AABB)
- 将来の変更で閾値を超えたら警告
- Accept: baseline 値がテストに組み込まれている
